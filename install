#!/bin/sh -x

# @TODO Fix gammastep
# @TODO add service for nextcloud client (automatic) start
# @TODO add explanatory comments for keepassxc setup (SSH Agent + Secret Service)

export XDG_CONFIG_HOME="$HOME/.config"

sudo xbps-install $(grep -o '^[^#]*' packages.txt | tr '\n' ' ')

# Enable NTP Daemon on boot
test -d /var/service/ntpd || sudo ln -s /etc/sv/ntpd /var/service/

# Start Seat Manager on boot
test -d /var/service/dbus || sudo ln -s /etc/sv/dbus /var/service/
test -d /var/service/elogind || sudo ln -s /etc/sv/elogind /var/service/

# Start bluetooth service on boot
test -d /var/service/bluetoothd || sudo ln -s /etc/sv/bluetoothd /var/service/

# Start cron service on boot
test -d /var/service/cronie || sudo ln -s /etc/sv/cronie /var/service/

# Start docker daemon on boot
test -d /var/service/docker || sudo ln -s /etc/sv/docker /var/service/

# Update font settings
sudo xbps-reconfigure fontconfig

# Put user to group necessary for sway to work
sudo usermod -a -G input $USER

# Put user to group necessary for audio (pulseaudio) to work
sudo usermod -a -G audio $USER

# Put user to group necessary for bluetooth to work
sudo usermod -a -G bluetooth $USER

# Put user to group to allow to control docker
sudo usermod -a -G docker $USER

# Link sway configuration
SWAY_CFG_DIR=$XDG_CONFIG_HOME/sway
test -L $SWAY_CFG_DIR || ln -s $PWD/.config/sway $SWAY_CFG_DIR

# Link rofi configuration the dmenu replacement
ROFI_CFG_DIR=$XDG_CONFIG_HOME/rofi
test -L $ROFI_CFG_DIR || ln -s $PWD/.config/rofi $ROFI_CFG_DIR

# Background image
test -f $HOME/.background.png || ln -s $PWD/background.png $HOME/.background.png

# Lock screen image
test -f $HOME/.swaylock.png || ln -s $PWD/swaylock.png $HOME/.swaylock.png

# Alacritty configuration
ALACRITTY_CFG_DIR=$XDG_CONFIG_HOME/alacritty
test -L $ALACRITTY_CFG_DIR || ln -s $PWD/.config/alacritty $ALACRITTY_CFG_DIR

# Set default shell to zsh
chsh -s /bin/zsh $(whoami)

# Remove left overs
rm ~/.bash*

# Setup zsh
test -L $HOME/.zshrc || ln -s $PWD/.zshrc $HOME/
test -L $HOME/.zlogin || ln -s $PWD/.zlogin $HOME/
test -L $HOME/.zshenv || ln -s $PWD/.zshenv $HOME/
test -L $HOME/.dir_colors || ln -s $PWD/.dir_colors $HOME/

# zsh antigen plugin manager
test -L $HOME/.antigen.zsh || ln -s $PWD/antigen.zsh $HOME/.antigen.zsh

# Vim plugin manager (basically downloads GitHub repositories)
mkdir -p $HOME/.vim/autoload
test -L $HOME/.vim/autoload/plug.vim || ln -s $PWD/.vim/autoload/plug.vim \
    $HOME/.vim/autoload/plug.vim

# Vim configuration
test -L $HOME/.vimrc || ln -s $PWD/.vimrc $HOME/

# zsh ssh-agent plugins needs this directory
mkdir -p $HOME/.ssh

# Install thefuck application: Fixes typos by entering fuck
sudo pip install thefuck

# Install latest Noto Color Emoji font
test -L $HOME/.fonts || ln -s $PWD/.fonts $HOME/.fonts
fc-cache -fv

# This is where backup and swp files of vim go
mkdir -p $HOME/.cache/vim

# Add Void source packages
mkdir $HOME/src
cd $HOME/src
git clone https://github.com/void-linux/void-packages.git
cd void-packages
./xbps-src binary-bootstrap

# Allow installing "nonfree" packages
echo XBPS_ALLOW_RESTRICTED=yes >> etc/conf

# Install Vivaldi browser
if [ -z "$(xpkg | grep vivaldi)" ]; then
    ./xbps-src pkg vivaldi
    sudo xbps-install --repository hostdir/binpkgs/nonfree vivaldi
fi

# Install Spotify
if [ -z "$(xpkg | grep spotify)" ]; then
    ./xbps-src pkg spotify
    sudo xbps-install --repository hostdir/binpkgs/nonfree spotify
fi

cowsay -f tux "YaY - Almost done, just some hints left."

echo "Vim"
echo "- Make sure to run :PlugInstall when you run vim for the first time"
echo "- You may want to review the plugins in .vimrc at GitHub before install"
echo

echo "Vivaldi"
echo "- Colors for a theme to make it Nord like:"
echo "Background: #2e3440"
echo "Foreground: #d8dee9"
echo "Highlight: #81a1c1"
echo "Accent: #434c5e"
echo
